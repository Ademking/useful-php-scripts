<?php  // https://github.com/tazotodua/useful-php-scripts/

/* DESCRIPTION: this script will help you MUCH!! sometimes, when migrating site (or in SQL file, you want to replace strings), 
dont do it manually! because the strings should be changed in SERIALIZED ARRAYS too, and that needs special replacement, 
not just the direct replacement...   so, this script will do that... */
// LIVE DEMO:  http://protectpages.com/files/WordpressMigrator.php



if (!empty($_FILES['dbfilee'])) {
	
	function DOMAIN_or_STRING_modifier_in_DB($old_string,  $new_string, $sql_content,     $download = false){
		set_time_limit(1000);
		$length_difference= strlen($old_string)- strlen($new_string);
		$old_string_slashed=str_replace('/','\/',$old_string);
		// Replace every occurence of Serialized arrays, i.e. {s:32:"blablabla"}
		preg_match_all('/(\}|\{|\;)s\:(.*?){1,5}\:\"(.*?)\"/si', $sql_content, $n, PREG_SET_ORDER);
		foreach($n as $each){
			if(!is_numeric($each[2])) {continue;}  else { $found_char_length= $each[2];}
			if(stripos($each[3],$old_string)===false){ continue; }
			$before_s_SYMBOL = $each[1]; //i.e.  | or } or {
			$found_line	= $each[0];	 
			$found_line_changed	= str_replace(
				array($before_s_SYMBOL.'s:'.$found_char_length,							$old_string),
				array($before_s_SYMBOL.'s:'.($found_char_length - $length_difference),	$new_string),
				$found_line);
			$sql_content	= str_replace($found_line,	    str_replace($old_string,$new_string,$found_line_changed),    $sql_content);
		}
		// Now, we can freely replace  typical occurences
		$sql_content=str_replace($old_string,$new_string,$sql_content);
		if ($download) { header('Content-Type: application/octet-stream');	header("Content-Transfer-Encoding: Binary"); header('Content-disposition: attachment; filename="db_'.rand(1,99999).'.sql"');  echo $sql_content; exit; }   else {return $sql_content;}
	}
	// EXECUTION !!!
	DOMAIN_or_STRING_modifier_in_DB($_POST['oldstr'], $_POST['newstr'],     file_get_contents($_FILES["dbfilee"]["name"]),    true);
}


else { ?>
	<form action="" method="POST" enctype="multipart/form-data"><h1>Intelligenty replaces words or domains with new values</h1><br/><br/>
	Old string <input type="text" value="" placeholder="i.e. word1 or http://domain1.com" name="oldstr" style="width:300px;" /><br/>
	new string<input type="text" value="" placeholder="i.e. word2 or http://domain2.com" style="width:300px;" name="newstr" /><br/>
	drag database file here:<input type="file" name="dbfilee" /><br/><input type="submit" value="GENERATE NEW DB" /> (and wait some time...)
	</form>
	<?php
}
?>
